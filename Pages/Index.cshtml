@page
@model MyRazorApp.Pages.IndexModel
@{
    ViewData["Title"] = "Dashboard";
}

@section Styles {
    <link rel="stylesheet" href="~/css/inventory.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/dashboard.css" asp-append-version="true" />
}

<div class="container">

    <header class="page-header-section">
        <h1 class="page-header-title">
            Welcome, @Model.CurrentUser?.Username! 👋
        </h1>
        <p class="page-header-subtitle">
            You are logged in as <strong>@Model.CurrentUser?.Role</strong>.
            Here are your key metrics:
        </p>
    </header>

    <div class="dashboard-metrics">
        <div class="dashboard-cards">

            @if (Model.CurrentUser?.Role == "admin")
            {
                <div class="card card-metric card-admin-inventory">
                    <div class="card-header">
                        <span class="card-icon-wrapper">
                            <i class="fas fa-boxes"></i>
                        </span>
                        <h3>Inventory Items</h3>
                    </div>
                    <p class="card-metric-value">@Model.TotalItems</p>
                    <p class="card-subtitle">total items in system</p>
                    <a href="/Admin/Inventory/Index" class="btn btn-primary">Manage Items</a>
                </div>

                <div class="card card-metric card-admin-users">
                    <div class="card-header">
                        <span class="card-icon-wrapper">
                            <i class="fas fa-users-cog"></i>
                        </span>
                        <h3>Users</h3>
                    </div>
                    <p class="card-metric-value">@Model.TotalUsers</p>
                    <p class="card-subtitle">total active accounts</p>
                    <a href="/Admin/Users/Index" class="btn btn-primary">Manage Users</a>
                </div>

                <div class="card card-metric card-admin-log">
                    <div class="card-header">
                        <span class="card-icon-wrapper">
                            <i class="fas fa-clipboard-list"></i>
                        </span>
                        <h3>Borrow Log</h3>
                    </div>
                    <p class="card-metric-value">@Model.TotalLogs</p>
                    <p class="card-subtitle">total transactions logged</p>
                    <a href="/Admin/BorrowLog/Index" class="btn btn-primary">View Log</a>
                </div>
            }
            else
            {
                <div class="card card-metric card-client-borrowed">
                    <div class="card-header">
                        <span class="card-icon-wrapper">
                            <i class="fas fa-toolbox"></i>
                        </span>
                        <h3>My Borrowed Items</h3>
                    </div>
                    <p class="card-metric-value">@Model.MyBorrowedCount</p>
                    <p class="card-subtitle">items currently checked out</p>
                    <a href="/Client/BorrowItem/Index" class="btn btn-primary">View My Items</a>
                </div>

                <div class="card card-metric card-client-available">
                    <div class="card-header">
                        <span class="card-icon-wrapper">
                            <i class="fas fa-search"></i>
                        </span>
                        <h3>Available Items</h3>
                    </div>
                    <p class="card-metric-value">@Model.AvailableItems</p>
                    <p class="card-subtitle">items ready for check out</p>
                    <a href="/Client/ClientItems/Index" class="btn btn-primary">Browse Items</a>
                </div>
            }
        </div>
    </div>

    <hr class="dashboard-divider" />

    @if (Model.CurrentUser?.Role == "admin")
    {
        <div class="dashboard-body">

            <div class="dashboard-row">

                <div class="card dashboard-chart-lg">
                    <div class="card-header">
                        <span class="card-icon-wrapper-sm">
                            <i class="fas fa-chart-bar"></i>
                        </span>
                        <h3>Borrowing Trends (Last 30 Days)</h3>
                    </div>

                    <div class="chart-container">
                        <canvas id="borrowTrendChart"></canvas>
                    </div>
                </div>

                <div class="card dashboard-sidebar">
                    <div class="card-header">
                        <span class="card-icon-wrapper-sm">
                            <i class="fas fa-bell"></i>
                        </span>
                        <h3>Quick Status</h3>
                    </div>

                    <ul class="status-list">
                        <li class="status-overdue">
                            <i class="fas fa-circle"></i>
                            Items Overdue: <strong>@Model.ItemsOverdueCount</strong>
                        </li>

                        <li class="status-available">
                            <i class="fas fa-circle"></i>
                            Items Available: <strong>@Model.AvailableItems</strong>
                        </li>

                        <li class="status-pending">
                            <i class="fas fa-circle"></i>
                            Users Pending Verification: <strong>@Model.PendingUserCount</strong>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="dashboard-activity">
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon-wrapper-sm">
                            <i class="fas fa-history"></i>
                        </span>
                        <h3>Recent Borrowing Activity</h3>
                    </div>

                    <table class="table table-hover table-activity">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Item</th>
                                <th class="text-center">Quantity</th>
                                <th>Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var borrow in Model.RecentBorrows)
                            {
                                <tr>
                                    <td>@borrow.Username</td>
                                    <td>@borrow.ItemName</td>
                                    <td class="text-center">@borrow.Quantity</td>
                                    <td>@borrow.Date.ToString("yyyy-MM-dd")</td>
                                    <td><span class="status-badge status-@borrow.Status.ToLower()">@borrow.Status</span></td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <a href="/Admin/BorrowLog/Index" class="btn btn-secondary mt-3">
                        View Full Log
                    </a>
                </div>
            </div> 
        </div>
    }
    else
    {
        <div class="dashboard-body-client">
            <div class="alert alert-info">
                You currently have **@Model.MyPendingRequestCount** pending borrow request(s). Check the <a href="/Client/BorrowItem/Index">**My Borrowed Items**</a> page for status updates.
            </div>
        </div>
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script>
        var trendsData = @Html.Raw(Json.Serialize(Model.BorrowingTrends)); 

        // 3. Prepare labels (Dates) and data points (Counts)
        var labels = trendsData.map(function(item) {
            return item.date.substring(0, 10); // Format to YYYY-MM-DD
        });
        var dataPoints = trendsData.map(function(item) {
            return item.count;
        });

        // 4. Get the canvas context
        var ctx = document.getElementById('borrowTrendChart').getContext('2d');

        // 5. Create the Line Chart
        var borrowTrendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total Borrows',
                    data: dataPoints,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)', // Light blue fill
                    borderColor: 'rgba(54, 162, 235, 1)',      // Solid blue line
                    borderWidth: 2,
                    tension: 0.3, // Makes the line slightly curved
                    pointRadius: 3 // Size of the dots
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Borrows'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    </script>
}