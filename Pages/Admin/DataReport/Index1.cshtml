@page
@model MyRazorApp.Pages.Admin.DataReport.IndexModel
@{
    ViewData["Title"] = "Data Dashboard";
}

@section Styles {
    <link rel="stylesheet" href="~/css/inventory.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/datareport.css" asp-append-version="true" />
}

<div class="container-fluid datareport-page">
    <header class="page-header d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="page-title"><i class="fas fa-chart-pie"></i> Data Analytics</h2>
            <p class="text-muted mb-0">Overview of inventory health and movement.</p>
        </div>
    </header>

        <div class="filter-bar d-flex flex-wrap align-items-center gap-3 shadow-sm">
        <div class="d-flex align-items-center gap-2">
            <i class="fas fa-filter text-secondary"></i>
            <span class="fw-bold text-secondary">Filter Data:</span>
        </div>
        
        <select id="filterView" class="form-select form-select-sm" style="width:auto;">
            <option value="all">All Time</option>
            <option value="month">Monthly</option>
        </select>

        <select id="filterMonth" class="form-select form-select-sm" style="width:auto;" disabled>
            <option value="">Select Month</option>
            @for (int m = 1; m <= 12; m++) {
                <option value="@m">@System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(m)</option>
            }
        </select>

        <select id="filterYear" class="form-select form-select-sm" style="width:auto;" disabled>
            <option value="">Select Year</option>
            @{ var yr = DateTime.Now.Year; }
            @for (int y = yr - 2; y <= yr; y++) {
                <option value="@y">@y</option>
            }
        </select>

        <div class="filter-separator"></div>

        <button id="btnRefresh" class="btn btn-primary btn-sm ms-auto">
            <i class="fas fa-sync-alt"></i> Apply Filter
        </button>
    </div>

    <div class="row g-4">

        <div class="col-lg-6">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-white"><h6 class="m-0 font-weight-bold text-primary">Top Borrowed Items</h6></div>
                <div class="card-body d-flex">
                    <div class="chart-wrapper flex-fill"><canvas id="chartTopBorrowed"></canvas></div>
                    <div class="flex-fill ms-3 table-wrapper">
                        <div class="table-responsive">
                            <table class="table table-sm" id="tableTopBorrowed">
                                <thead><tr><th>Item</th><th class="text-end">Qty</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>    
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-white"><h6 class="m-0 font-weight-bold text-success">Borrow Status</h6></div>
                <div class="card-body d-flex">
                    <div class="chart-wrapper flex-fill"><canvas id="chartStatus"></canvas></div>
                    <div class="flex-fill ms-3 table-wrapper">
                        <div class="table-responsive">
                            <table class="table table-sm" id="tableStatus">
                                <thead><tr><th>User</th><th>Item</th><th>Status</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-white"><h6 class="m-0 font-weight-bold text-warning">Return Requests</h6></div>
                <div class="card-body d-flex">
                    <div class="chart-wrapper flex-fill"><canvas id="chartRequests"></canvas></div>
                    <div class="flex-fill ms-3 table-wrapper">
                        <div class="table-responsive">
                            <table class="table table-sm" id="tableRequests">
                                <thead><tr><th>User</th><th>Item</th><th>Type</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-white"><h6 class="m-0 font-weight-bold text-danger">Condition Issues</h6></div>
                <div class="card-body d-flex">
                    <div class="chart-wrapper flex-fill"><canvas id="chartConditions"></canvas></div>
                    <div class="flex-fill ms-3 table-wrapper">
                        <div class="table-responsive">
                            <table class="table table-sm" id="tableConditions">
                                <thead><tr><th>Item</th><th>Condition</th><th>Date</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-white">
                    <h6 class="m-0 font-weight-bold text-danger">Low Stock Items</h6>
                </div>
                <div class="card-body d-flex">
                    <div class="chart-wrapper flex-fill">
                        <canvas id="chartLowStock"></canvas>
                    </div>
                    <div class="flex-fill ms-3 table-wrapper">
                        <div class="table-responsive">
                            <table class="table table-sm" id="tableLowStock">
                                <thead>
                                    <tr><th>Item</th><th class="text-end">Qty</th></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>    
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // 1. Initial Data from Server (Serialized C# Model)
    const initialData = {
        topBorrowed: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.TopBorrowedItems)),
        borrowStatus: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.BorrowStatusTotals)),
        returnRequests: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ReturnRequestTotals)),
        returnConditions: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ReturnConditionTotals)),
        lowStock: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.LowStockItems)),

        details_borrow: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.BorrowStatusDetails ?? new Dictionary<string, List<object>>())),
        details_return: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ReturnRequestDetails ?? new Dictionary<string, List<object>>())),
        details_condition: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ReturnConditionDetails ?? new Dictionary<string, List<object>>()))
    };

    const charts = {}; // Store chart instances

    document.addEventListener('DOMContentLoaded', () => {
        // Render Initial View
        renderAll(initialData);

        // UI Logic
        const viewSel = document.getElementById('filterView');
        const mSel = document.getElementById('filterMonth');
        const ySel = document.getElementById('filterYear');
        const btn = document.getElementById('btnRefresh');

        // Initial set of date defaults
        const now = new Date();
        mSel.value = now.getMonth() + 1;
        ySel.value = now.getFullYear();

        viewSel.addEventListener('change', () => {
            const isAll = viewSel.value === 'all';
            mSel.disabled = isAll;
            ySel.disabled = isAll;
        });

        // REFRESH BUTTON CLICK
        btn.addEventListener('click', async () => {
            const view = viewSel.value;
            const month = mSel.value;
            const year = ySel.value;

            // Loading State
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            btn.disabled = true;

            try {
                // Fetch JSON from Handler
                const url = `/Admin/DataReport?handler=DashboardData&view=${view}&month=${month}&year=${year}`;
                const res = await fetch(url);
                if(!res.ok) throw new Error("Fetch failed");
                const newData = await res.json();
                
                // Update Everything
                renderAll(newData);
            } catch(e) {
                console.error(e);
                alert("Failed to load report data.");
            } finally {
                btn.innerHTML = '<i class="fas fa-sync-alt"></i> Apply Filter';
                btn.disabled = false;
            }
        });
    });

    // ---------------- HELPER FUNCTIONS ----------------

    function renderAll(data) {
        // Update Charts
        updateChart('chartTopBorrowed', data.topBorrowed);
        updateChart('chartStatus', data.borrowStatus);
        updateChart('chartRequests', data.returnRequests);
        updateChart('chartConditions', data.returnConditions);
        updateChart('chartLowStock', data.lowStock);


        // Update Tables
        updateSimpleTable('tableTopBorrowed', data.topBorrowed);
        updateSimpleTable('tableLowStock', data.lowStock);
        updateComplexTable('tableStatus', data.details_borrow, ['user', 'item', 'status']);
        updateComplexTable('tableRequests', data.details_return, ['user', 'item', 'type']);
        updateComplexTable('tableConditions', data.details_condition, ['item', 'extra', 'date']);
    }

    function updateChart(canvasId, dataMap) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        const labels = Object.keys(dataMap || {});
        const values = Object.values(dataMap || {});
        const colors = ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'];

        if (charts[canvasId]) {
            // Update existing
            charts[canvasId].data.labels = labels.length ? labels : ["No Data"];
            charts[canvasId].data.datasets[0].data = values.length ? values : [1];
            charts[canvasId].data.datasets[0].backgroundColor = values.length ? colors : ['#efefef'];
            charts[canvasId].update();
        } else {
            // Create new
            charts[canvasId] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.length ? labels : ["No Data"],
                    datasets: [{
                        data: values.length ? values : [1],
                        backgroundColor: values.length ? colors : ['#efefef'],
                        borderWidth: 1
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 10 } } }
                }
            });
        }
    }

    function updateSimpleTable(tableId, dataMap) {
        const tbody = document.querySelector(`#${tableId} tbody`);
        tbody.innerHTML = '';
        if(!dataMap || Object.keys(dataMap).length === 0) {
            tbody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">No Data</td></tr>';
            return;
        }
        for(const [k, v] of Object.entries(dataMap)) {
            tbody.innerHTML += `<tr><td>${k}</td><td class="text-end fw-bold">${v}</td></tr>`;
        }
    }

    function updateComplexTable(tableId, detailsObj, keys) {
        // DetailsObj comes from C# as Dictionary<string, List<object>>
        // We need to flatten it.
        const tbody = document.querySelector(`#${tableId} tbody`);
        tbody.innerHTML = '';
        
        let flatList = [];
        if(detailsObj) {
            Object.values(detailsObj).forEach(list => {
                if(Array.isArray(list)) flatList.push(...list);
            });
        }

        if(flatList.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No Data</td></tr>';
            return;
        }

        flatList.forEach(obj => {
            // Mapping dynamic object keys safely
            const col1 = obj.user || obj.username || obj.User || obj.ItemName || obj.item || '-';
            const col2 = obj.item || obj.ItemName || obj.type || obj.condition || '-'; 
            const col3 = obj.status || obj.type || obj.extra || obj.date || '-';
            
            // Adjust this based on your exact object structure coming from Mongo
            let row = `<tr><td>${col1}</td><td>${col2}</td><td>${col3}</td></tr>`;
            
            // Specific overrides for your specific tables if generic mapping fails:
            if(tableId === 'tableStatus') {
                 // Expecting: User, Item, Status
                 const u = obj.UserName || obj.User || obj.user || "Unknown";
                 const i = obj.ItemName || obj.Item || obj.item || "Unknown";
                 const s = obj.Status || obj.status || "Unknown";
                 row = `<tr><td>${u}</td><td>${i}</td><td><span class="badge bg-secondary">${s}</span></td></tr>`;
            }

            tbody.innerHTML += row;
        });
    }
</script>
}