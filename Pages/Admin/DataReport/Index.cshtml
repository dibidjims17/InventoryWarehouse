@page
@model MyRazorApp.Pages.Admin.DataReport.IndexModel
@{
    ViewData["Title"] = "Data Reports";
}

@section Styles {
    <link rel="stylesheet" href="~/css/inventory.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/datareport.css" asp-append-version="true" />
}

<div class="container datareport-page">
    <header class="page-header">
        <h2 class="page-title"><i class="fas fa-chart-bar"></i> Data Report Dashboard</h2>
        <p class="page-subtitle">Visual statistics on item usage, status, and inventory health.</p>
    </header>

    <div class="row g-4">

        <!-- Top Borrowed Items -->
        <div class="col-lg-6 col-md-12">
            <div class="card h-100 shadow-sm datareport-card">
                <div class="card-header"><h5 class="card-title"><i class="fas fa-medal"></i> Top Borrowed Items</h5></div>
                <div class="card-body d-flex flex-column flex-md-row p-3">
                    <div class="chart-container flex-fill chart-combined-top">
                        <canvas id="topBorrowedCombinedChart"></canvas>
                    </div>

                    <div class="chart-sidebar flex-fill ms-md-3 mt-3 mt-md-0">
                        <form id="searchForm" method="get">
                            <div class="d-flex gap-2 mb-2 chart-filter-controls">
                                <select id="viewSelect" class="form-control form-select-sm" name="view">
                                    <option value="all" selected>All Time</option>
                                    <option value="month">Monthly</option>
                                </select>

                                <select id="monthSelect" class="form-control form-select-sm" name="month" disabled>
                                    <option value="">--Month--</option>
                                    @for (int m = 1; m <= 12; m++)
                                    {
                                        var monthName = new DateTime(2000, m, 1).ToString("MMMM");
                                        <option value="@m">@monthName</option>
                                    }
                                </select>

                                <select id="yearSelect" class="form-control form-select-sm" name="year" disabled>
                                    <option value="">--Year--</option>
                                    @{
                                        int currentYear = DateTime.Now.Year;
                                        for (int y = currentYear - 5; y <= currentYear; y++)
                                        {
                                            <option value="@y">@y</option>
                                        }
                                    }
                                </select>
                            </div>
                        </form>

                        <div class="table-responsive table-scroll-wrapper">
                            <table class="table table-striped table-sm mb-0 datareport-table" id="fullListTable">
                                <thead>
                                    <tr>
                                        <th>Item Name</th>
                                        <th class="text-end">Quantity</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Borrow Status Breakdown -->
        <div class="col-lg-6 col-md-12">
            <div class="card h-100 shadow-sm datareport-card">
                <div class="card-header"><h5 class="card-title"><i class="fas fa-clipboard-list"></i> Borrow Status Breakdown</h5></div>
                <div class="card-body d-flex flex-column flex-md-row p-3">
                    <div class="chart-container flex-fill">
                        <canvas id="borrowStatusChart"></canvas>
                    </div>
                    <div class="chart-sidebar flex-fill ms-md-3 mt-3 mt-md-0">
                        <div class="badge-list">
                            @foreach (var kv in Model.BorrowStatusTotals)
                            {
                                <span class="badge badge-status-summary status-@kv.Key.ToLower() me-1 mb-1">@kv.Key: @kv.Value</span>
                            }
                        </div>

                        <div class="table-responsive mt-2 table-scroll-wrapper">
                            <table class="table table-striped table-sm mb-0 datareport-table" id="borrowStatusTable">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Item</th>
                                        <th class="text-end">Qty</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Return Requests -->
        <div class="col-lg-6 col-md-12">
             <div class="card h-100 shadow-sm datareport-card">
                <div class="card-header"><h5 class="card-title"><i class="fas fa-undo-alt"></i> Pending Return Requests</h5></div>
                <div class="card-body d-flex flex-column flex-md-row p-3">
                    <div class="chart-container flex-fill">
                        <canvas id="returnRequestChart"></canvas>
                    </div>
                    <div class="chart-sidebar flex-fill ms-md-3 mt-3 mt-md-0">
                        <div class="badge-list">
                            @foreach (var kv in Model.ReturnRequestTotals)
                            {
                                <span class="badge badge-status-summary status-@kv.Key.ToLower() me-1 mb-1">@kv.Key: @kv.Value</span>
                            }
                        </div>

                        <div class="table-responsive mt-2 table-scroll-wrapper">
                            <table class="table table-striped table-sm mb-0 datareport-table" id="returnRequestTable">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Item</th>
                                        <th class="text-end">Qty</th>
                                        <th>Type</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Return Condition Issues -->
        <div class="col-lg-6 col-md-12">
            <div class="card h-100 shadow-sm datareport-card">
                <div class="card-header"><h5 class="card-title"><i class="fas fa-wrench"></i> Return Condition Issues</h5></div>
                <div class="card-body d-flex flex-column flex-md-row p-3">
                    <div class="chart-container flex-fill">
                        <canvas id="returnConditionChart"></canvas>
                    </div>
                    <div class="chart-sidebar flex-fill ms-md-3 mt-3 mt-md-0">
                        <div class="badge-list">
                            @foreach (var kv in Model.ReturnConditionTotals)
                            {
                                <span class="badge badge-status-summary status-@kv.Key.ToLower() me-1 mb-1">@kv.Key: @kv.Value</span>
                            }
                        </div>

                        <div class="table-responsive mt-2 table-scroll-wrapper">
                            <table class="table table-striped table-sm mb-0 datareport-table" id="returnConditionTable">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Item</th>
                                        <th class="text-end">Qty</th>
                                        <th>Condition</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Low Stock Warning -->
        <div class="col-lg-6 col-md-12">
            <div class="card h-100 shadow-sm datareport-card">
                <div class="card-header text-danger">
                    <h5 class="card-title"><i class="fas fa-exclamation-triangle"></i> Low Stock Warning</h5>
                </div>
                <div class="card-body d-flex flex-column flex-md-row p-3">
                    <div class="chart-container flex-fill">
                        <canvas id="lowStockChart"></canvas>
                    </div>
                    
                    <div class="chart-sidebar flex-fill ms-md-3 mt-3 mt-md-0">
                        <h6 class="mb-2 text-danger">Items Below Threshold:</h6>

                        @if (Model.LowStockItems.Any())
                        {
                            <div class="table-responsive table-scroll-wrapper">
                                <table class="table table-striped table-sm mb-0 datareport-table" id="lowStockTable">
                                    <thead>
                                        <tr>
                                            <th>Item Name</th>
                                            <th class="text-end">Current Stock</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var kv in Model.LowStockItems)
                                        {
                                            <tr>
                                                <td>@kv.Key</td>
                                                <td class="text-end text-danger">@kv.Value</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <p class="mt-3 text-success">
                                <i class="fas fa-check-circle"></i> **No items are currently below the stock threshold.**
                            </p>
                        }
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // -----------------------------
    // Data passed from Razor model
    // -----------------------------
    window.DataReport = {
        TopBorrowedItems: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.TopBorrowedItems)),
        BorrowStatusTotals: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.BorrowStatusTotals)),
        ReturnRequestTotals: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ReturnRequestTotals)),
        ReturnConditionTotals: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ReturnConditionTotals)),
        UserActivityTotals: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.UserActivityTotals)),
        LowStockItems: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.LowStockItems)),
        BorrowStatusDetails: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.BorrowStatusDetails ?? new Dictionary<string, List<object>>())),
        ReturnRequestDetails: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ReturnRequestDetails ?? new Dictionary<string, List<object>>())),
        ReturnConditionDetails: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ReturnConditionDetails ?? new Dictionary<string, List<object>>())),
    };

    // -----------------------------
    // Utilities
    // -----------------------------
    function generateColors(n) {
        const palette = ['#3b82f6','#10b981','#ef4444','#f59e0b','#8b5cf6','#06b6d4','#f97316','#eab308','#14b8a6','#6366f1'];
        return Array.from({length: Math.max(1, n)}, (_, i) => palette[i % palette.length]);
    }

    function safeGet(obj, key, fallback = []) {
        try {
            const v = obj[key];
            return v ?? fallback;
        } catch (e) {
            return fallback;
        }
    }

    // -----------------------------
    // Generic pie renderer
    // -----------------------------
    function renderInteractivePieChart(canvasId, labels, data, chartTitle = "") {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return null;

        const ctx = canvas.getContext('2d');

        return new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels.length ? labels : ["No data"],
                datasets: [{
                    data: data.length ? data : [1],
                    backgroundColor: generateColors(labels.length || 1),
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    title: { display: !!chartTitle, text: chartTitle },
                    tooltip: { callbacks: { label: ctx => ctx.label + ': ' + ctx.parsed } }
                }
            }
        });
    }

    // -----------------------------
    // Populate detail tables
    // -----------------------------
    function populateDetailsTableFlatten(tableId, dictOrArray, extraKeyName = 'status') {
        const tbody = document.querySelector(`#${tableId} tbody`);
        if (!tbody) return;
        tbody.innerHTML = '';

        if (!dictOrArray) {
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center">No data</td></tr>`;
            return;
        }

        let entries = [];

        if (typeof dictOrArray === 'object' && !Array.isArray(dictOrArray)) {
            for (const [k, arr] of Object.entries(dictOrArray)) {
                if (!arr) continue;
                for (const item of arr) {
                    entries.push({
                        user: item.user ?? item.username ?? item.UserName ?? item.User ?? '',
                        item: item.item ?? item.item_name ?? item.ItemName ?? item.Item ?? '',
                        qty: item.qty ?? item.quantity ?? item.Qty ?? 0,
                        extra: k,
                        type: item.type ?? item.status ?? '',
                        date: item.date ?? item.requested_at ?? item.returned_at ?? ''
                    });
                }
            }
        } else if (Array.isArray(dictOrArray)) {
            entries = dictOrArray.map(item => ({
                user: item.user ?? item.username ?? '',
                item: item.item ?? item.item_name ?? '',
                qty: item.qty ?? item.quantity ?? 0,
                type: item.type ?? item.status ?? '',
                extra: item.extra ?? '',
                date: item.date ?? ''
            }));
        }

        if (entries.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center">No data</td></tr>`;
            return;
        }

        for (const row of entries) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td style="padding:6px; text-align:center;">${row.user}</td>
                            <td style="padding:6px; text-align:center;">${row.item}</td>
                            <td style="padding:6px; text-align:center;">${row.qty}</td>
                            <td style="padding:6px; text-align:center;">${row.type || row.extra}</td>
                            <td style="padding:6px; text-align:center;">${row.date}</td>`;
            tbody.appendChild(tr);
        }
    }

    // -----------------------------
    // Top Borrowed Items pie chart + table
    // -----------------------------
    let combinedChart = null;

    async function fetchMonthData(month, year) {
        try {
            const url = `/Admin/DataReport?handler=MonthData&month=${month}&year=${year}`;
            const res = await fetch(url);
            if (!res.ok) throw new Error('Network error');
            return await res.json();
        } catch (e) {
            console.error('fetchMonthData failed', e);
            return { top10: {}, fullList: {} };
        }
    }

    async function renderCombinedTopBorrowed(month, year) {
        let top10 = {};
        let fullList = {};

        if (!month || month === 'all') {
            top10 = window.DataReport.TopBorrowedItems ?? {};
            fullList = window.DataReport.TopBorrowedItems ?? {};
        } else {
            const json = await fetchMonthData(month, year);
            top10 = json.top10 ?? {};
            fullList = json.fullList ?? {};
        }

        const labels = Object.keys(top10);
        const values = Object.values(top10);

        const canvas = document.getElementById('topBorrowedCombinedChart');
        if (!canvas) return;
        if (combinedChart) combinedChart.destroy();

        combinedChart = new Chart(canvas.getContext('2d'), {
            type: 'pie',
            data: { labels: labels.length ? labels : ['No data'], datasets: [{ data: values.length ? values : [1], backgroundColor: generateColors(labels.length || 1), borderWidth: 1 }] },
            options: { responsive: true, plugins: { legend: { position: 'bottom' }, title: { display: true, text: month && month !== 'all' ? `Top Borrowed (Month ${month}/${year})` : 'Top Borrowed (All Time)' } } }
        });

        // Populate table
        const tbody = document.querySelector('#fullListTable tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        const fl = fullList || {};
        if (Object.keys(fl).length === 0) {
            tbody.innerHTML = `<tr><td colspan="2" style="padding:6px; text-align:center">No items</td></tr>`;
        } else {
            for (const [item, qty] of Object.entries(fl)) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td style="padding:6px; text-align:center;">${item}</td>
                                <td style="padding:6px; text-align:center;">${qty}</td>`;
                tbody.appendChild(tr);
            }
        }
    }

    // -----------------------------
    // DOM Ready
    // -----------------------------
    document.addEventListener('DOMContentLoaded', function () {
        const viewSelect = document.getElementById('viewSelect');
        const monthSelect = document.getElementById('monthSelect');
        const yearSelect = document.getElementById('yearSelect');
        const currentYear = (new Date()).getFullYear();

        // Render all static charts
        renderInteractivePieChart("borrowStatusChart", Object.keys(window.DataReport.BorrowStatusTotals||{}), Object.values(window.DataReport.BorrowStatusTotals||{}), "Borrow Status");
        renderInteractivePieChart("returnRequestChart", Object.keys(window.DataReport.ReturnRequestTotals||{}), Object.values(window.DataReport.ReturnRequestTotals||{}), "Return Requests");
        renderInteractivePieChart("returnConditionChart", Object.keys(window.DataReport.ReturnConditionTotals||{}), Object.values(window.DataReport.ReturnConditionTotals||{}), "Return Conditions");
        renderInteractivePieChart("userActivityChart", Object.keys(window.DataReport.UserActivityTotals||{}), Object.values(window.DataReport.UserActivityTotals||{}), "User Activity");
        renderInteractivePieChart("lowStockChart", Object.keys(window.DataReport.LowStockItems||{}), Object.values(window.DataReport.LowStockItems||{}), "Low Stock Items");

        // Populate detail tables
        populateDetailsTableFlatten('borrowStatusTable', window.DataReport.BorrowStatusDetails);
        populateDetailsTableFlatten('returnRequestTable', window.DataReport.ReturnRequestDetails);
        populateDetailsTableFlatten('returnConditionTable', window.DataReport.ReturnConditionDetails);

        // Render Top Borrowed Items chart + table
        renderCombinedTopBorrowed('all', currentYear);

        // Update chart when filters change
        viewSelect.addEventListener('change', function () {
            const v = viewSelect.value;
            if (v === 'all') {
                monthSelect.disabled = true;
                yearSelect.disabled = true;
                renderCombinedTopBorrowed('all', currentYear);
            } else {
                monthSelect.disabled = false;
                yearSelect.disabled = false;
                renderCombinedTopBorrowed(monthSelect.value || (new Date()).getMonth() + 1, yearSelect.value || currentYear);
            }
        });

        monthSelect.addEventListener('change', function () {
            if (viewSelect.value === 'month') renderCombinedTopBorrowed(monthSelect.value, yearSelect.value);
        });

        yearSelect.addEventListener('change', function () {
            if (viewSelect.value === 'month') renderCombinedTopBorrowed(monthSelect.value, yearSelect.value);
        });
    });
</script>
}
