@page
@model MyRazorApp.Pages.Client.UserProfile.IndexModel
@{
    ViewData["Title"] = "User Profile";
}

@section Styles {
    <link rel="stylesheet" href="~/css/profile.css" asp-append-version="true" />
}
<div class="container py-4 user-profile-page">

    <h2 class="page-title mb-4"><i class="fas fa-user-circle"></i> Account Settings</h2>

    @if (!string.IsNullOrEmpty(Model.Message))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @Model.Message
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row g-4">

        <div class="col-lg-4 col-md-12">
            <section class="card h-100 shadow-sm profile-info-card">
                <div class="card-body text-center">
                    
                    <div class="profile-picture-wrapper mb-4">
                        <img src="@(string.IsNullOrEmpty(Model.CurrentUser.ProfilePicture) 
                                     ? "/uploads/profile_pics/default.png" 
                                     : $"/uploads/{Model.CurrentUser.ProfilePicture}")" 
                             alt="Profile Picture"
                             class="profile-picture clickable-pic" 
                             onclick="toggleProfileMenu()" />

                        <div id="profileMenu" class="profile-menu shadow">
                            <button type="button" class="menu-close" onclick="closeProfileMenu()">Ã—</button>
                            <button type="button" class="menu-btn btn btn-sm btn-dark" onclick="document.getElementById('changePhotoInput').click()">
                                <i class="fas fa-camera"></i> Change Photo
                            </button>
                            <button type="button" class="menu-btn btn btn-sm btn-danger" onclick="document.getElementById('removePhotoForm').submit()">
                                <i class="fas fa-trash-alt"></i> Remove Photo
                            </button>
                        </div>

                        <form id="changePhotoForm" method="post" enctype="multipart/form-data" asp-page-handler="Upload" style="display:none;">
                            <input type="file" id="changePhotoInput" asp-for="ProfilePictureFile" accept="image/*" onchange="this.form.submit()" />
                        </form>
                        <form id="removePhotoForm" method="post" asp-page-handler="RemovePicture" style="display:none;"></form>
                    </div>

                    <h4 class="mb-1 text-primary">@Model.CurrentUser.Username</h4>
                    <p class="text-muted small">User ID: @Model.CurrentUser.UserId</p>
                    
                </div>
            </section>
        </div>

        <div class="col-lg-8 col-md-12">
            <section class="card shadow-sm profile-forms-card">
                <div class="card-body">
                    
                    <h5 class="card-title mb-3"><i class="fas fa-pencil-alt"></i> Update Username</h5>
                    <form method="post" asp-page-handler="ChangeUsername" class="mb-4 pb-4 border-bottom">
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" asp-for="CurrentUser.Username" class="form-control" required />
                            <span asp-validation-for="CurrentUser.Username" class="text-danger"></span>
                        </div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Update Username</button>
                    </form>

                    <h5 class="card-title mb-3 mt-4"><i class="fas fa-lock"></i> Change Password</h5>
                    <form method="post" asp-page-handler="ChangePassword">
                        <div class="mb-3">
                            <label class="form-label">Current Password</label>
                            <input type="password" asp-for="CurrentPassword" class="form-control" required />
                            <span asp-validation-for="CurrentPassword" class="text-danger"></span>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">New Password</label>
                            <input type="password" asp-for="NewPassword" class="form-control" required />
                            <span asp-validation-for="NewPassword" class="text-danger"></span>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Confirm New Password</label>
                            <input type="password" asp-for="ConfirmPassword" class="form-control" required />
                            <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                        </div>
                        <button type="submit" class="btn btn-success"><i class="fas fa-key"></i> Change Password</button>
                    </form>
                    
                </div>
            </section>
        </div>

    </div>
</div>

@section Scripts {
    <script>
    function toggleProfileMenu() {
        const menu = document.getElementById('profileMenu');
        menu.classList.toggle('show');
    }

    function closeProfileMenu() {
        document.getElementById('profileMenu').classList.remove('show');
    }
    
    // Close the menu if the user clicks anywhere outside
    document.addEventListener('click', function(event) {
        const menu = document.getElementById('profileMenu');
        const picture = document.querySelector('.clickable-pic');
        
        // If the menu is open and the click target is neither the picture nor inside the menu
        if (menu.classList.contains('show') && !menu.contains(event.target) && event.target !== picture) {
            closeProfileMenu();
        }
    });
    </script>
}